<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Tutoriales - Gestor de Videos por Tema</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
            color: var(--accent-color);
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .logo span {
            color: var(--accent-color);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 25px;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        nav a:hover, nav a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main content */
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar */
        .sidebar {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 25px;
            height: fit-content;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }

        .section-title i {
            color: var(--secondary-color);
        }

        .theme-list {
            list-style: none;
            margin-bottom: 30px;
        }

        .theme-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: var(--light-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .theme-item:hover {
            background-color: #e0e6ea;
            transform: translateX(5px);
        }

        .theme-item.active {
            background-color: var(--secondary-color);
            color: white;
        }

        .theme-count {
            background-color: white;
            color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .active .theme-count {
            background-color: var(--primary-color);
            color: white;
        }

        /* Contenido principal */
        .content {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 25px;
        }

        /* Barra de búsqueda */
        .search-bar {
            display: flex;
            margin-bottom: 25px;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .search-btn {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Grid de videos */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .video-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .video-thumbnail {
            position: relative;
            height: 180px;
            overflow: hidden;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .video-info {
            padding: 15px;
        }

        .video-theme {
            display: inline-block;
            background-color: var(--light-color);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .video-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
            line-height: 1.4;
        }

        .video-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-date {
            font-size: 12px;
            color: #888;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 14px;
        }

        /* Modal para ver video */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #888;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--accent-color);
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            margin-bottom: 20px;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 5px;
        }

        /* Footer */
        footer {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 40px;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            align-items: center;
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
        }

        .footer-links a:hover {
            color: var(--accent-color);
        }

        /* Páginas de documentación */
        .docs-content {
            margin-top: 30px;
        }

        .doc-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .doc-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .doc-card p {
            margin-bottom: 15px;
        }

        .doc-link {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .doc-link:hover {
            text-decoration: underline;
        }

        /* Status indicators */
        .status-active {
            color: var(--success-color);
            font-weight: bold;
        }

        .status-inactive {
            color: #999;
        }

        /* Configuración de conexión */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Mensajes de carga */
        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--secondary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mensajes de alerta */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Estilos para estadísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            nav ul {
                gap: 15px;
            }

            .footer-content {
                flex-direction: column;
                gap: 15px;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }

            .search-bar {
                flex-direction: column;
            }

            .search-bar input, .search-bar button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-play-circle"></i>
                <h1>Videos de Apoyo Docente<span> - DIRAGE</span></h1>
                <span id="connection-status" class="connection-status disconnected">
                    <i class="fas fa-circle"></i> Desconectado
                </span>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="active" data-page="videos"><i class="fas fa-video"></i> Videos</a></li>
                    <li><a href="#" data-page="stats"><i class="fas fa-chart-bar"></i> Estadísticas</a></li>
                   <!-- <li><a href="#" data-page="docs"><i class="fas fa-file-alt"></i> Ayuda</a></li>-->
                </ul>
            </nav>
        </div>
    </header>

    <!-- Contenido principal -->
    <div class="container">
        <!-- Panel de videos (página principal) -->
        <div id="videos-page" class="page-content">
            <div class="main-content">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <h2 class="section-title"><i class="fas fa-filter"></i> Temas</h2>
                    <ul class="theme-list" id="theme-list">
                        <li class="theme-item active">
                            Todos
                            <span class="theme-count">0</span>
                        </li>
                        <!-- Los temas se cargarán dinámicamente -->
                    </ul>

                   
                </aside>

                <!-- Contenido principal -->
                <main class="content">
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Buscar videos por título, tema, etiquetas...">
                        <button id="search-btn" class="search-btn"><i class="fas fa-search"></i> Buscar</button>
                        <button id="refresh-btn" class="btn btn-accent" style="width: auto;">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>

                    <h2 class="section-title">
                        <i class="fas fa-play-circle"></i> Videos Disponibles 
                        <span id="video-count" style="font-size: 14px; color: #666; margin-left: 10px;">(cargando...)</span>
                    </h2>
                    
                    <div id="alert-container"></div>
                    
                    <div class="video-grid" id="video-grid">
                        <div class="loading-message" id="loading-message">
                            <div class="loading-spinner"></div>
                            <p>Cargando videos desde Google Sheets...</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <!-- Página de estadísticas -->
        <div id="stats-page" class="page-content" style="display: none;">
            <div class="content">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> Estadísticas de Videos</h2>
                
                <div class="stats-grid" id="stats-grid">
                    <!-- Estadísticas se cargarán dinámicamente -->
                </div>
                
                <h3 class="section-title"><i class="fas fa-list"></i> Distribución por Tema</h3>
                <div id="themes-chart" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: var(--shadow); margin-top: 20px;">
                    <p>Los datos se cargarán cuando se conecte a la hoja de cálculo...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal para ver video -->
    <div id="video-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Título del Video</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="video-container">
                <iframe id="modal-video" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <div id="modal-info">
                <!-- Información del video se cargará aquí -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="copyright">
                <p>&copy; 2026 Video de Apoyo DIRAGE - Visualizador de Videos</p>
                <p style="font-size: 12px; margin-top: 5px;">Los videos se gestionan directamente desde DIRAGE</p>
            </div>
            <div class="footer-links">
        <!--         <a href="#" data-page="docs"><i class="fas fa-question-circle"></i> Ayuda</a>
               <a href="https://docs.google.com/spreadsheets/d/1w3cle3iuRxLrK20YuC51xzc8--celSCWEmLjIxbvVoA/edit" target="_blank">
                    <i class="fas fa-external-link-alt"></i> Ver Hoja
                </a>-->
            </div>
        </div>
    </footer>

    <script>
    // Configuración - ID de tu hoja de cálculo
    const SHEET_ID = '1w3cle3iuRxLrK20YuC51xzc8--celSCWEmLjIxbvVoA';
    
    // IMPORTANTE: Reemplaza esta URL con la de TU Google Apps Script
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhPA8DJJzcPBbuhV_euCi6otp_wQ0wNf2uXWO1YNaIz-Ao9eBb9Wmx2rAHFUbPJxDr/exec';
    
    let videos = [];
    let currentFilter = 'all';
    let isLoading = false;

    // Inicializar la aplicación cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        loadVideos();
    });

    async function loadVideos() {
        if (isLoading) return;
        
        isLoading = true;
        showLoading(true);
        updateConnectionStatus('Conectando...');
        
        try {
            // Usar la API pública de Google Sheets para leer datos
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const text = await response.text();
            // Google Sheets devuelve los datos en un formato especial, necesitamos procesarlos
            const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
            const data = JSON.parse(jsonText);
            
            // Verificar si hay datos
            if (!data.table || !data.table.rows) {
                videos = [];
                showAlert('La hoja de cálculo está vacía o no tiene datos.', 'info');
                updateConnectionStatus('Conectado');
                renderVideos([]);
                return;
            }
            
            // Extraer encabezados de columna
            const headers = data.table.cols.map(col => col.label);
            
            // Convertir filas a objetos
            videos = data.table.rows.map((row, index) => {
                const video = {};
                headers.forEach((header, colIndex) => {
                    if (row.c && row.c[colIndex]) {
                        video[header] = row.c[colIndex].v || '';
                    } else {
                        video[header] = '';
                    }
                });
                
                // Asegurar que tenemos un ID
                if (!video.id || video.id === '') {
                    video.id = index + 1;
                }
                
                return video;
            });
            
            updateConnectionStatus('Conectado');
            showAlert(`Se cargaron ${videos.length} videos correctamente.`, 'success');
            renderVideos(videos);
            renderThemes();
            updateStats();
            
        } catch (error) {
            console.error('Error cargando videos:', error);
            updateConnectionStatus('Desconectado');
            showAlert(`Error al cargar videos: ${error.message}. Asegúrate de que la hoja esté compartida públicamente.`, 'error');
            renderVideos([]);
        } finally {
            isLoading = false;
            showLoading(false);
        }
    }

    function initApp() {
        // Navegación entre páginas
        const navLinks = document.querySelectorAll('nav a');
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.getAttribute('data-page');
                
                // Actualizar estado activo en navegación
                navLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Mostrar página seleccionada
                document.querySelectorAll('.page-content').forEach(p => {
                    p.style.display = 'none';
                });
                document.getElementById(`${page}-page`).style.display = 'block';
                
                // Actualizar estadísticas si es necesario
                if (page === 'stats') {
                    updateStats();
                }
            });
        });

        // Botón de actualizar
        document.getElementById('refresh-btn').addEventListener('click', function() {
            loadVideos();
        });

        // Manejar búsqueda
        document.getElementById('search-btn').addEventListener('click', performSearch);
        document.getElementById('search-input').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Manejar cierre del modal
        document.querySelector('.close-modal').addEventListener('click', closeModal);
        document.getElementById('video-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    }

    function extractYouTubeId(url) {
        if (!url) return null;
        
        const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        
        if (match && match[2].length === 11) {
            return match[2];
        }
        
        // También intentar con formato youtu.be
        const shortRegExp = /youtu\.be\/([^#&?]*)/;
        const shortMatch = url.match(shortRegExp);
        
        if (shortMatch && shortMatch[1].length === 11) {
            return shortMatch[1];
        }
        
        return null;
    }

    function renderThemes() {
        const themeList = document.getElementById('theme-list');
        
        // Contar videos por tema (solo activos)
        const themeCounts = {};
        const activeVideos = videos.filter(v => {
            const status = v.status || 'active';
            return (status === 'active' || status === 'Active' || status === 'Activo');
        });
        
        activeVideos.forEach(video => {
            const theme = video.theme || 'Sin tema';
            themeCounts[theme] = (themeCounts[theme] || 0) + 1;
        });
        
        // Limpiar lista
        themeList.innerHTML = '';
        
        // Agregar "Todos" como primer tema
        const totalVideos = activeVideos.length;
        const allThemesItem = document.createElement('li');
        allThemesItem.className = 'theme-item active';
        allThemesItem.innerHTML = `
            Todos
            <span class="theme-count">${totalVideos}</span>
        `;
        allThemesItem.addEventListener('click', function() {
            document.querySelectorAll('.theme-item').forEach(item => item.classList.remove('active'));
            this.classList.add('active');
            currentFilter = 'all';
            renderVideos(activeVideos);
        });
        themeList.appendChild(allThemesItem);
        
        // Agregar temas individuales
        Object.keys(themeCounts).sort().forEach(theme => {
            const count = themeCounts[theme];
            
            const themeItem = document.createElement('li');
            themeItem.className = 'theme-item';
            
            // Capitalizar primera letra del tema
            const themeName = theme.charAt(0).toUpperCase() + theme.slice(1);
            
            themeItem.innerHTML = `
                ${themeName}
                <span class="theme-count">${count}</span>
            `;
            
            themeItem.addEventListener('click', function() {
                document.querySelectorAll('.theme-item').forEach(item => item.classList.remove('active'));
                this.classList.add('active');
                currentFilter = theme;
                const filteredVideos = activeVideos.filter(video => video.theme === theme);
                renderVideos(filteredVideos);
            });
            
            themeList.appendChild(themeItem);
        });
    }

    function renderVideos(videosToRender) {
        const videoGrid = document.getElementById('video-grid');
        const videoCount = document.getElementById('video-count');
        
        videoCount.textContent = `(${videosToRender.length} videos)`;
        
        if (videosToRender.length === 0) {
            videoGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">No hay videos que coincidan con tu búsqueda.</p>';
            return;
        }
        
        videoGrid.innerHTML = '';
        
        videosToRender.forEach(video => {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';
            
            // Obtener nombre del tema para mostrar
            const theme = video.theme || 'Sin tema';
            const themeName = theme.charAt(0).toUpperCase() + theme.slice(1);
            
            // Extraer ID de YouTube para thumbnail
            const videoId = extractYouTubeId(video.url);
            const thumbnail = videoId ? 
                `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : 
                'https://via.placeholder.com/300x180/cccccc/666666?text=Video';
            
            // Estado del video
            const status = video.status || 'active';
            const statusClass = (status === 'active' || status === 'Active' || status === 'Activo') ? 'status-active' : 'status-inactive';
            const statusText = (status === 'active' || status === 'Active' || status === 'Activo') ? 'Activo' : 'Inactivo';
            
            // Duración
            const duration = video.duration || '0:00';
            
            // Fecha
            const date = video.date_added || 'Fecha desconocida';
            
            // Rating
            const rating = video.rating || 0;
            
            videoCard.innerHTML = `
                <div class="video-thumbnail">
                    <img src="${thumbnail}" alt="${video.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x180/cccccc/666666?text=Video'">
                    <span class="video-duration">${duration}</span>
                </div>
                <div class="video-info">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span class="video-theme">${themeName}</span>
                        <span class="${statusClass}" style="font-size: 10px;">${statusText}</span>
                    </div>
                    <h3 class="video-title">${video.title || 'Sin título'}</h3>
                    <p class="video-description">${video.description || 'Sin descripción'}</p>
                    ${video.tags ? `<p style="font-size: 12px; color: #666; margin-bottom: 10px;"><i class="fas fa-tags"></i> ${video.tags}</p>` : ''}
                    <div class="video-actions">
                        <div>
                            <span class="video-date"><i class="far fa-calendar"></i> ${date}</span>
                            ${rating > 0 ? `<span style="margin-left: 10px; color: #f39c12;"><i class="fas fa-star"></i> ${rating}</span>` : ''}
                        </div>
                        <button class="action-btn view-video-btn" data-id="${video.id}">
                            <i class="fas fa-play"></i> Ver video
                        </button>
                    </div>
                </div>
            `;
            
            videoGrid.appendChild(videoCard);
        });
        
        // Agregar event listeners a los botones de ver video
        document.querySelectorAll('.view-video-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const videoId = this.getAttribute('data-id');
                const video = videos.find(v => v.id == videoId);
                if (video) {
                    openModal(video);
                }
            });
        });
    }

    function performSearch() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        const activeVideos = videos.filter(v => {
            const status = v.status || 'active';
            return (status === 'active' || status === 'Active' || status === 'Activo');
        });
        
        if (!searchTerm) {
            // Si no hay término de búsqueda, aplicar filtro actual
            if (currentFilter === 'all' || currentFilter === 'Todos') {
                renderVideos(activeVideos);
            } else {
                const filteredVideos = activeVideos.filter(video => video.theme === currentFilter);
                renderVideos(filteredVideos);
            }
            return;
        }
        
        const filteredVideos = activeVideos.filter(video => 
            (video.title && video.title.toLowerCase().includes(searchTerm)) ||
            (video.description && video.description.toLowerCase().includes(searchTerm)) ||
            (video.theme && video.theme.toLowerCase().includes(searchTerm)) ||
            (video.tags && video.tags.toLowerCase().includes(searchTerm))
        );
        
        renderVideos(filteredVideos);
    }

    function updateStats() {
        const statsGrid = document.getElementById('stats-grid');
        const themesChart = document.getElementById('themes-chart');
        
        if (videos.length === 0) {
            statsGrid.innerHTML = '<p>No hay datos para mostrar estadísticas.</p>';
            themesChart.innerHTML = '<p>No hay datos para mostrar gráfico.</p>';
            return;
        }
        
        // Calcular estadísticas
        const totalVideos = videos.length;
        const activeVideos = videos.filter(v => {
            const status = v.status || 'active';
            return (status === 'active' || status === 'Active' || status === 'Activo');
        }).length;
        
        // Contar temas únicos
        const themes = {};
        videos.forEach(video => {
            const theme = video.theme || 'Sin tema';
            themes[theme] = (themes[theme] || 0) + 1;
        });
        const uniqueThemes = Object.keys(themes).length;
        
        // Videos con rating > 0
        const ratedVideos = videos.filter(v => v.rating && parseFloat(v.rating) > 0).length;
        
        // Renderizar estadísticas
        statsGrid.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${totalVideos}</div>
                <div class="stat-label">Videos Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${activeVideos}</div>
                <div class="stat-label">Videos Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${uniqueThemes}</div>
                <div class="stat-label">Temas Diferentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${ratedVideos}</div>
                <div class="stat-label">Videos Calificados</div>
            </div>
        `;
        
        // Renderizar gráfico de temas
        let chartHTML = '<h4>Videos por Tema</h4>';
        
        // Ordenar temas por cantidad
        const sortedThemes = Object.entries(themes).sort((a, b) => b[1] - a[1]);
        
        sortedThemes.forEach(([theme, count]) => {
            const percentage = Math.round((count / totalVideos) * 100);
            chartHTML += `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${theme}</span>
                        <span>${count} (${percentage}%)</span>
                    </div>
                    <div style="height: 10px; background-color: #ecf0f1; border-radius: 5px; overflow: hidden;">
                        <div style="height: 100%; width: ${percentage}%; background-color: #3498db; border-radius: 5px;"></div>
                    </div>
                </div>
            `;
        });
        
        themesChart.innerHTML = chartHTML;
    }

    function openModal(video) {
        const modal = document.getElementById('video-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalVideo = document.getElementById('modal-video');
        const modalInfo = document.getElementById('modal-info');
        
        // Configurar contenido del modal
        modalTitle.textContent = video.title || 'Sin título';
        
        // Asegurar que la URL sea embed
        let videoUrl = video.url || '';
        const videoId = extractYouTubeId(videoUrl);
        if (videoId) {
            modalVideo.src = `https://www.youtube.com/embed/${videoId}`;
        } else {
            modalVideo.src = videoUrl;
        }
        
        // Información adicional del video
        const theme = video.theme || 'Sin tema';
        const themeName = theme.charAt(0).toUpperCase() + theme.slice(1);
        
        modalInfo.innerHTML = `
            <p><strong>Tema:</strong> ${themeName}</p>
            <p><strong>Fecha de agregado:</strong> ${video.date_added || 'Fecha desconocida'}</p>
            <p><strong>Duración:</strong> ${video.duration || '0:00'}</p>
            ${video.description ? `<p><strong>Descripción:</strong> ${video.description}</p>` : ''}
            ${video.tags ? `<p><strong>Etiquetas:</strong> ${video.tags}</p>` : ''}
            ${video.views ? `<p><strong>Vistas:</strong> ${video.views}</p>` : ''}
            ${video.rating ? `<p><strong>Calificación:</strong> ${video.rating}/5</p>` : ''}
            ${video.created_by ? `<p><strong>Agregado por:</strong> ${video.created_by}</p>` : ''}
        `;
        
        // Mostrar modal
        modal.style.display = 'flex';
    }

    function closeModal() {
        const modal = document.getElementById('video-modal');
        const modalVideo = document.getElementById('modal-video');
        
        // Detener video al cerrar modal
        modalVideo.src = '';
        modal.style.display = 'none';
    }

    function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connection-status');
        if (status === 'Conectado') {
            statusElement.innerHTML = '<i class="fas fa-circle" style="color: #28a745;"></i> Conectado';
            statusElement.className = 'connection-status connected';
        } else if (status === 'Desconectado') {
            statusElement.innerHTML = '<i class="fas fa-circle" style="color: #dc3545;"></i> Desconectado';
            statusElement.className = 'connection-status disconnected';
        } else if (status === 'Conectando...') {
            statusElement.innerHTML = '<i class="fas fa-circle" style="color: #ffc107;"></i> Conectando...';
            statusElement.className = 'connection-status disconnected';
        }
    }

    function showLoading(show) {
        const loadingElement = document.getElementById('loading-message');
        if (show) {
            loadingElement.style.display = 'block';
        } else {
            loadingElement.style.display = 'none';
        }
    }

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            ${message}
        `;
        
        alertContainer.appendChild(alertDiv);
        
        // Remover después de 5 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
</body>
</html>